<!DOCTYPE html>
<html lang="zh-CN">
<head>

// åœ¨ UserSys.init() åé¢è°ƒç”¨ CloudSys.init();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å—æ²™æ²³ä¸­å­¦: å»‰æ´æ ¡å›­è¡ŒåŠ¨ (é‡åŒ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <style>
        :root {
            --primary: #4a90e2;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f1c40f;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --font-stack: "Helvetica Neue", "Microsoft YaHei", sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; padding: 0; 
            overflow: hidden; 
            background: #222; 
            font-family: var(--font-stack);
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none;
            height: 100dvh; width: 100vw;
        }

        /* åŠ¨ç”»èƒŒæ™¯ */
        .animated-bg {
            position: absolute; width: 100%; height: 100%; top:0; left:0; z-index: -1;
            background: linear-gradient(-45deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        /* é€šç”¨å…¨å±å®¹å™¨ */
        .full-screen { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        /* èœå•æ ·å¼ */
        #menu-screen { z-index: 200; overflow-y: auto; padding-bottom: 50px; }
        .menu-header {
            text-align: center; margin-bottom: 15px; padding: 15px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%; max-width: 400px;
            border: 4px solid var(--dark);
            position: relative;
        }
        .menu-title { 
            font-size: 1.8rem; color: var(--dark); font-weight: 900; margin: 0;
            letter-spacing: 1px;
        }
        .menu-subtitle { font-size: 0.8rem; color: #666; margin-top: 5px; font-weight: bold; }
        
        .btn-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            width: 90%; max-width: 400px; padding-bottom: 40px;
        }

        .mode-btn {
            background: rgba(255,255,255,0.9); color: var(--dark);
            border: none; padding: 12px; height: 100px;
            border-radius: 16px;
            box-shadow: 0 4px 0 #bdc3c7;
            cursor: pointer;
            transition: all 0.1s;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .mode-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #bdc3c7; }
        .mode-icon { font-size: 2.2rem; margin-bottom: 5px; }
        .mode-text { font-size: 0.95rem; font-weight: 800; }
        .mode-desc { font-size: 0.65rem; color: #777; margin-top: 2px; }

        /* ç‰¹æ®ŠæŒ‰é’® */
        .btn-notice {
            position: absolute; top: 10px; left: 10px; /* ç§»åˆ°å·¦è¾¹ */
            background: var(--warning); color: var(--dark);
            border: 2px solid var(--dark); border-radius: 50%;
            width: 36px; height: 36px; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* ä¸ªäººæ¡£æ¡ˆæŒ‰é’® (å³ä¸Šè§’) */
        .btn-profile {
            position: absolute; top: 10px; right: 10px;
            background: var(--primary); color: white;
            border: 2px solid var(--dark); border-radius: 50%;
            width: 36px; height: 36px; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
                /* æ’è¡Œæ¦œæŒ‰é’® (ç´«è‰²ï¼Œåœ¨ä¸ªäººæ¡£æ¡ˆå·¦è¾¹) */
        .btn-rank {
            position: absolute; top: 10px; right: 55px;
            background: #9b59b6; color: white;
            border: 2px solid var(--dark); border-radius: 50%;
            width: 36px; height: 36px; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        
        .btn-update { 
            grid-column: span 2; 
            background: linear-gradient(to right, #11998e, #38ef7d); 
            color: white; height: 60px; flex-direction: row; gap: 15px;
            box-shadow: 0 4px 0 #0e7a72;
        }

        /* æ¸¸æˆå®¹å™¨èƒŒæ™¯ */
        #game-a-container { background-color: #fdfbf7; background-image: radial-gradient(#d0d0d0 1px, transparent 1px); background-size: 20px 20px; }
        #game-b-container { background: linear-gradient(180deg, #87CEEB 0%, #87CEEB 100px, #8B4513 100px, #5D2906 100%); }
        #game-c-container { background: linear-gradient(to bottom, #1e3c72 0%, #2a5298 100%); } 
        #game-d-container { background: #c0392b; background-image: repeating-linear-gradient(90deg, transparent, transparent 48%, rgba(255,255,255,0.3) 49%, rgba(255,255,255,0.3) 51%, transparent 52%); }
        #game-e-container { background: #34495e; }
        #game-f-container { background: #27ae60; background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;}

        canvas { 
            box-shadow: 0 0 20px rgba(0,0,0,0.3); 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1); 
            touch-action: none;
        }

        /* UIå±‚é€šç”¨ */
        .ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; padding-top: max(10px, env(safe-area-inset-top));
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            pointer-events: none;
        }
        
        .back-btn { 
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); 
            padding: 8px 16px; border-radius: 20px; cursor: pointer; 
            pointer-events: auto; font-size: 0.9rem; font-weight: bold; backdrop-filter: blur(4px);
        }
        .score-badge { 
            background: rgba(0,0,0,0.6); color: #f1c40f; 
            padding: 5px 15px; border-radius: 20px; 
            font-size: 1.2rem; font-weight: 900; 
            border: 2px solid #f1c40f;
            text-shadow: 0 2px 0 #000;
        }

        /* å¼¹çª— */
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 300; justify-content: center; align-items: center; pointer-events: auto; backdrop-filter: blur(5px); }
        .modal-box { 
            background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 320px; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 4px solid var(--dark);
            box-shadow: 0 10px 0 rgba(0,0,0,0.2);
            max-height: 80vh; overflow-y: auto;
        }
        @keyframes popIn { from{transform:scale(0.8); opacity: 0;} to{transform:scale(1); opacity: 1;} }
        
        .action-btn {
            width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: 900; cursor: pointer; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-restart { background: var(--success); }
        .btn-menu { background: var(--dark); }

        /* å…¬å‘Šå†…å®¹ */
        .notice-content { text-align: left; font-size: 0.9rem; line-height: 1.6; color: #333; margin: 10px 0; }
        .notice-content h3 { color: var(--primary); margin: 0 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .notice-content li { margin-bottom: 5px; }

        /* æ¡£æ¡ˆ & ç™»å½• æ ·å¼ */
        .profile-stat { background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: left; border-left: 5px solid var(--primary); }
        .history-list { max-height: 150px; overflow-y: auto; text-align: left; font-size: 0.85rem; border: 1px solid #eee; padding: 5px; border-radius: 5px; margin-top: 10px; }
        .history-item { padding: 5px; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between; }
        .history-item.bad { color: var(--danger); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark); }
        .input-group input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); }

        /* éŸ³é¢‘æ§åˆ¶ */
        .sound-toggle {
            position: absolute; bottom: 20px; right: 20px;
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.8); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 300;
        }

        /* Game F: ç¿»ç‰Œ */
        .card-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            width: 90%; max-width: 360px; aspect-ratio: 4/5;
            margin-top: 20px;
        }
        .card {
            background: #fff; border-radius: 8px; cursor: pointer;
            position: relative; transform-style: preserve-3d; transition: transform 0.4s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { visibility: hidden; pointer-events: none; }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center;
            border-radius: 8px; font-size: 2rem;
        }
        .card-front { background: #34495e; color: white; border: 2px solid #2c3e50; } /* èƒŒé¢ */
        .card-back { background: #fff; transform: rotateY(180deg); border: 2px solid var(--primary); }
        .card-back img { width: 80%; height: 80%; object-fit: contain; border-radius: 50%; }

        /* Game E ç‰¹æœ‰æ ·å¼ */
        .building-grid {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            width: 90%; max-width: 400px;
        }
        .window-cell {
            aspect-ratio: 1; background: #555; border: 4px solid #7f8c8d; border-radius: 5px;
            position: relative; overflow: hidden; cursor: pointer; box-shadow: inset 0 0 20px #000;
        }
        .window-cell.lit { background: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        .window-content {
            width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-end;
            pointer-events: none;
        }
        .window-img { width: 80%; height: 80%; object-fit: contain; transform: translateY(100%); transition: transform 0.2s; }
        .window-img.show { transform: translateY(10px); }

        /* Game D æ—‹è½¬æç¤º */
        #rotate-tip {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); color: white; z-index: 500;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }

    </style>
</head>
<body>

    <div id="loading-screen" class="full-screen" style="display: flex; background: #fff; z-index: 400;">
        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ«</div>
        <h2 style="color: var(--primary);">æ­£åœ¨æ‰“æ‰«æ ¡å›­...</h2>
        <div id="loading-bar" style="color:#666; margin-top:10px;">0%</div>
    </div>

    <div class="sound-toggle" onclick="toggleMute()" id="mute-btn">ğŸ”Š</div>

    <div id="login-modal" class="modal" style="display: none; z-index: 500;">
        <div class="modal-box">
            <h2 style="color: var(--primary);">å­¦ç”Ÿæ¡£æ¡ˆç™»è®°</h2>
            <div class="input-group">
                <label>ä½ çš„ç­çº§</label>
                <input type="text" id="user-class" placeholder="ä¾‹å¦‚ï¼šä¹ä¸€" maxlength="10">
            </div>
            <div class="input-group">
                <label>ä½ çš„å§“å</label>
                <input type="text" id="user-name" placeholder="è¯·è¾“å…¥æ¸¸æˆæ˜µç§°" maxlength="10">
            </div>
            <button class="action-btn" style="background: var(--primary);" onclick="UserSys.login()">ç¡®è®¤ç™»è®°</button>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-box">
            <h2 style="color: var(--dark);">ğŸ“‚ ä¸ªäººæ¡£æ¡ˆ</h2>
            <div class="profile-stat">
                <div><b>å§“åï¼š</b><span id="p-name">--</span></div>
                <div><b>ç­çº§ï¼š</b><span id="p-class">--</span></div>
                <div><b>å½“å‰é‡åŒ–åˆ†ï¼š</b><span id="p-score" style="color:var(--primary); font-weight:bold;">100</span></div>
            </div>
            <div style="text-align:left; font-weight:bold; margin-top:10px; font-size:0.9rem;">è¿çºª/æ´»åŠ¨è®°å½•ï¼š</div>
            <div class="history-list" id="p-history">
                </div>
            <button class="action-btn btn-menu" onclick="document.getElementById('profile-modal').style.display='none'">å…³é—­</button>
            <button class="action-btn" style="background:#bdc3c7; font-size:0.8rem; margin-top:5px; padding:8px;" onclick="UserSys.reset()">âš ï¸ æ³¨é”€æ¡£æ¡ˆ (é‡ç½®)</button>
        </div>
    </div>

    <div id="menu-screen" class="full-screen">
        <div class="animated-bg"></div>
                <div class="menu-header">
            <button class="btn-notice" onclick="openNotice()">ğŸ“¢</button>
            <button class="btn-rank" onclick="CloudSys.openRankPanel()">ğŸ†</button>
            <button class="btn-profile" onclick="UserSys.openProfile()">ğŸ‘¤</button>
            <div class="menu-title">å—æ²™æ²³ä¸­å­¦<br>å¤§å†’é™©</div>
            <div class="menu-subtitle">V5.0 (é‡åŒ–è€ƒæ ¸ç‰ˆ)</div>
        </div>

        
        <div class="btn-grid">
            <button class="mode-btn" onclick="startGame('A')">
                <span class="mode-icon">ğŸ‰</span>
                <span class="mode-text">åˆæˆç‰¢æ ¡é•¿</span>
                <span class="mode-desc">ç‰©ç†åˆæˆ</span>
            </button>
            <button class="mode-btn" onclick="startGame('B')">
                <span class="mode-icon">ğŸ£</span>
                <span class="mode-text">ä¸‰è§’è´¸æ˜“</span>
                <span class="mode-desc">å‡å¦‚æˆ‘æ˜¯è‹±å›½ä½¬</span>
            </button>
            <button class="mode-btn" onclick="startGame('C')" style="background: #e3f2fd; border: 2px solid #2196f3;">
                <span class="mode-icon">ğŸ’°</span>
                <span class="mode-text">è‡ªåŠ¨æ‹¾å–å¿˜å…³</span>
                <span class="mode-desc">è°åœ¨æˆ‘åŠå…¬å®¤æ”¾çš„çº¢åŒ…ï¼</span>
            </button>
            <button class="mode-btn" onclick="startGame('E')">
                <span class="mode-icon">ğŸ”¦</span>
                <span class="mode-text">æ¨¡æ‹Ÿæ ¡é•¿</span>
                <span class="mode-desc">å·¡è§†è¯¾å ‚ï¼Œçœ‹å“ªä¸ªè€å¸ˆå·æ‡’ï¼Ÿ</span>
            </button>
            <button class="mode-btn" onclick="startGame('F')" style="background: #e8f8f5;">
                <span class="mode-icon">ğŸ§©</span>
                <span class="mode-text">æ…§çœ¼è¯†äºº</span>
                <span class="mode-desc">è®°å¿†ç¿»ç‰Œ</span>
            </button>
            <button class="mode-btn" onclick="startGame('D')" style="background: #fff4e6;">
                <span class="mode-icon">ğŸ¥Š</span>
                <span class="mode-text">é«˜ç‹PK</span>
                <span class="mode-desc">åŒå¨ç‹‚å–œ</span>
            </button>

            <button class="mode-btn btn-update" onclick="openUpdateLink()">
                <div style="font-size: 2rem;">â¬‡ï¸</div>
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <div style="font-size:1.1rem; font-weight:bold;">æ›´æ–°æ¸¸æˆ</div>
                </div>
            </button>
        </div>
    </div>

    <div id="notice-modal" class="modal">
        <div class="modal-box" style="text-align: left;">
            <div style="text-align: center; font-size: 1.5rem; margin-bottom: 10px;">ğŸ“œ æ ¡åŠ¡å…¬å‘Š</div>
            <div class="notice-content">
                <h3>é‡åŒ–è€ƒæ ¸ç³»ç»Ÿä¸Šçº¿</h3>
                <ul>
                    <li>âš ï¸ <b>è­¦å‘Šï¼š</b> æœ¬ç‰ˆæœ¬æ¥å…¥æ•™åŠ¡å¤„é‡åŒ–ç³»ç»Ÿã€‚</li>
                    <li>ğŸ“‰ <b>æ‰£åˆ†è§„åˆ™ï¼š</b> æ¸¸æˆå¤±è´¥ã€è¿çºªã€è¶…æ—¶ç­‰è¡Œä¸ºå°†ç›´æ¥æ‰£é™¤ç­çº§é‡åŒ–åˆ†ï¼Œå¹¶è®°å…¥ä¸ªäººç”µå­æ¡£æ¡ˆã€‚</li>
                    <li>ğŸ’¾ <b>å­˜æ¡£ï¼š</b> æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œåˆ·æ–°ä¸ä¼šä¸¢å¤±ã€‚è¯·çˆ±æƒœç¾½æ¯›ï¼</li>
                </ul>
                <div style="font-size:0.8rem; color:#999; text-align:center; margin-top:10px;">ç¥å„ä½åŒå­¦å¥½è¿ï¼</div>
            </div>
            <button class="action-btn btn-menu" onclick="closeNotice()">å…³é—­å…¬å‘Š</button>
        </div>
    </div>

    <div id="game-a-container" class="full-screen">
        <div class="top-bar">
            <button class="back-btn" onclick="backToMenu()">â†© é€€å‡º</button>
            <div class="score-badge"><span id="score-a">0</span></div>
            <div style="width:40px; height:40px; background:rgba(255,255,255,0.8); border-radius:50%; display:flex; justify-content:center; align-items:center; border:2px solid #ccc;">
                <img id="next-preview-img" style="width:30px; height:30px; border-radius:50%;">
            </div>
        </div>
        <div id="modal-a" class="modal">
            <div class="modal-box">
                <h2 style="color: var(--danger);">å®¹å™¨å·²æ»¡</h2>
                <div style="margin:10px 0; font-size: 1.2rem; color: #555;">åˆæˆå¾—åˆ†: <span id="final-score-a">0</span></div>
                <div style="background: #fee; color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold;">
                     æ‰£é™¤ç­çº§é‡åŒ–: 5åˆ†<br>
                     <span style="font-size:0.8rem; font-weight:normal;">åŸå› ï¼šåˆ¶é€ åƒåœ¾ï¼Œå µå¡å®¹å™¨</span>
                </div>
                <button class="action-btn btn-restart" onclick="startGame('A')">é‡è¯•</button>
                <button class="action-btn btn-menu" onclick="backToMenu()">èœå•</button>
            </div>
        </div>
    </div>

    <div id="game-b-container" class="full-screen">
        <div class="top-bar">
            <button class="back-btn" onclick="backToMenu()">â†© é€€å‡º</button>
            <div class="score-badge">Â¥ <span id="score-b">0</span></div>
            <div style="color:white; font-weight:bold;">â³ <span id="timer-b">60</span>s</div>
        </div>
        <canvas id="canvas-b"></canvas>
        <div id="modal-b" class="modal">
            <div class="modal-box">
                <h2 style="color: var(--primary);">æ¸…ç®—ç»“æŸ</h2>
                <div style="margin:10px 0; font-size: 1.2rem;">ç›ˆåˆ©: Â¥<span id="final-score-b">0</span></div>
                <div style="background: #fee; color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold;">
                     æ‰£é™¤ç­çº§é‡åŒ–: 3åˆ†<br>
                     <span style="font-size:0.8rem; font-weight:normal;">åŸå› ï¼šéæ³•è´¸æ˜“ï¼Œæ•°é¢ä¸è¶³</span>
                </div>
                <button class="action-btn btn-restart" onclick="startGame('B')">é‡è¯•</button>
                <button class="action-btn btn-menu" onclick="backToMenu()">èœå•</button>
            </div>
        </div>
    </div>

    <div id="game-c-container" class="full-screen">
        <div class="top-bar">
            <button class="back-btn" onclick="backToMenu()">â†© é€€å‡º</button>
            <div class="score-badge">å»‰æ´: <span id="score-c">0</span></div>
        </div>
        <div class="ui-overlay" id="overlay-c" style="display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5);">
            <div style="color:white; font-size:1.5rem; font-weight:bold; text-align:center;">
                <div>ç‚¹å‡»å±å¹•é£è¡Œ</div>
                <div style="font-size:1rem; margin-top:10px; color:#f1c40f;">âš ï¸ èº²é¿çº¢åŒ…å’Œé’±è¢‹ï¼</div>
            </div>
        </div>
        <canvas id="canvas-c"></canvas>
        <div id="modal-c" class="modal">
            <div class="modal-box">
                <h2 style="color: var(--danger);">ä½ è¢«è…èš€äº†!</h2>
                <div style="margin:10px 0;">åšæŒç§’æ•°: <span id="final-score-c">0</span></div>
                <div style="background: #fee; color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold;">
                     æ‰£é™¤ç­çº§é‡åŒ–: 10åˆ†<br>
                     <span style="font-size:0.8rem; font-weight:normal;">åŸå› ï¼šæ”¶å—çº¢åŒ…ï¼Œè¿åçºªå¾‹</span>
                </div>
                <button class="action-btn btn-restart" onclick="startGame('C')">æ‚”è¿‡é‡æ¥</button>
                <button class="action-btn btn-menu" onclick="backToMenu()">èœå•</button>
            </div>
        </div>
    </div>

    <div id="game-d-container" class="full-screen">
        <div id="rotate-tip"><h1>è¯·æ—‹è½¬æ‰‹æœº</h1></div>
        <button class="back-btn" style="position:absolute; left:50%; transform:translateX(-50%); top:10px; z-index:60;" onclick="backToMenu()">â†© é€€å‡º</button>
        <div style="position:absolute; width:100%; height:100%; top:0; left:0; display:flex;">
            <div id="p1-btn" style="flex:1; background:rgba(231,76,60,0.1); border-right:1px solid rgba(255,255,255,0.2);"></div>
            <div id="p2-btn" style="flex:1; background:rgba(52,152,219,0.1);"></div>
        </div>
        <canvas id="canvas-d"></canvas>
        <div id="modal-d" class="modal">
            <div class="modal-box">
                <h2 id="winner-d" style="color: var(--warning);">èƒœè€…äº§ç”Ÿ!</h2>
                <div style="background: #fee; color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold; margin-top:10px;">
                     æ‰£é™¤ç­çº§é‡åŒ–: 2åˆ†<br>
                     <span style="font-size:0.8rem; font-weight:normal;">åŸå› ï¼šæ ¡å›­æ–—æ®´ï¼Œé€ æˆä¸è‰¯å½±å“</span>
                </div>
                <button class="action-btn btn-restart" onclick="startGame('D')">å†æˆ˜</button>
                <button class="action-btn btn-menu" onclick="backToMenu()">èœå•</button>
            </div>
        </div>
    </div>

    <div id="game-e-container" class="full-screen">
        <div class="top-bar">
            <button class="back-btn" onclick="backToMenu()">â†© é€€å‡º</button>
            <div class="score-badge">çºªå¾‹: <span id="score-e">0</span></div>
            <div style="color:white; font-weight:bold;">â³ <span id="timer-e">30</span>s</div>
        </div>
        <div class="building-grid" id="grid-e"></div>
        <div id="modal-e" class="modal">
            <div class="modal-box">
                <h2 style="color: var(--dark);">å·¡è§†ç»“æŸ</h2>
                <div style="margin:10px 0; font-size: 1.2rem;">æŸ¥è·: <span id="final-score-e">0</span></div>
                <div style="background: #fee; color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold;">
                     æ‰£é™¤ç­çº§é‡åŒ–: 5åˆ†<br>
                     <span style="font-size:0.8rem; font-weight:normal;">åŸå› ï¼šç›‘ç®¡ä¸åŠ›ï¼Œéƒ¨åˆ†è€å¸ˆæ‘¸é±¼</span>
                </div>
                <button class="action-btn btn-restart" onclick="startGame('E')">ç»§ç»­</button>
                <button class="action-btn btn-menu" onclick="backToMenu()">èœå•</button>
            </div>
        </div>
    </div>

    <div id="game-f-container" class="full-screen">
        <div class="top-bar">
            <button class="back-btn" onclick="backToMenu()">â†© é€€å‡º</button>
            <div style="color:white; font-weight:bold;">â³ <span id="timer-f">45</span>s</div>
        </div>
        <div style="color:white; font-size:1.2rem; margin-bottom:10px; font-weight:bold; text-shadow:0 1px 2px black;">æ‰¾åˆ°ç›¸åŒçš„æ•™èŒå·¥</div>
        <div class="card-grid" id="grid-f"></div>
        <div id="modal-f" class="modal">
            <div class="modal-box">
                <h2 id="title-f" style="color: var(--success);">ä»»å‘½å®Œæˆ!</h2>
                <div style="margin:10px 0; font-size: 1.2rem;"><span id="final-score-f">0</span></div>
                <div id="deduct-f" style="display:none; background: #fee; color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold;">
                     æ‰£é™¤ç­çº§é‡åŒ–: 3åˆ†<br>
                     <span style="font-size:0.8rem; font-weight:normal;">åŸå› ï¼šäººäº‹ä»»å…æ•ˆç‡ä½ä¸‹</span>
                </div>
                <button class="action-btn btn-restart" onclick="startGame('F')">å†è¯•ä¸€æ¬¡</button>
                <button class="action-btn btn-menu" onclick="backToMenu()">èœå•</button>
            </div>
        </div>
    </div>

    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const TEACHERS = [
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83a06e78.png', radius: 25, score: 10 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83a96379.png', radius: 32, score: 20 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83b022cb.png', radius: 40, score: 40 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83b683ce.png', radius: 48, score: 60 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83c4be50.png', radius: 55, score: 80 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83e508d2.png', radius: 62, score: 100 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83e57f91.png', radius: 70, score: 150 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c84dc14d4.png', radius: 78, score: 350 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c84795983.png', radius: 88, score: 400 },
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83e65183.png', radius: 98, score: 2500, type: 'new_principal' }, 
            { src: 'https://free-img.400040.xyz/4/2025/11/22/6921c83e72667.png', radius: 110, score: 3000 }
        ];

        const ASSETS = {};
        let isMuted = false;

        // --- ç”¨æˆ·é‡åŒ–ç³»ç»Ÿ (æœ¬åœ°) ---
        const UserSys = {
            data: { name: "", class: "", score: 1000, history: [] },
            key: "nsh_student_data_v4",
            init: () => {
                const stored = localStorage.getItem(UserSys.key);
                if (stored) { UserSys.data = JSON.parse(stored); CloudSys.init(); } 
                else { document.getElementById('loading-screen').style.display = 'none'; document.getElementById('login-modal').style.display = 'flex'; }
            },
            login: () => {
                const name = document.getElementById('user-name').value.trim();
                const cls = document.getElementById('user-class').value.trim();
                if(!name || !cls) { alert("è¯·å¡«å†™çœŸå®ä¿¡æ¯ï¼"); return; }
                UserSys.data.name = name; UserSys.data.class = cls;
                UserSys.data.history.push({event: "å»ºç«‹æ¡£æ¡ˆ", change: 0, date: new Date().toLocaleTimeString()});
                UserSys.save();
                document.getElementById('login-modal').style.display = 'none';
                CloudSys.init(); AudioSys.sfx('win');
            },
            save: () => { localStorage.setItem(UserSys.key, JSON.stringify(UserSys.data)); },
            deduct: (gameName, amount, reason) => {
                UserSys.data.score -= amount;
                UserSys.data.history.unshift({ event: `[${gameName}] ${reason}`, change: -amount, date: new Date().toLocaleTimeString() });
                if(UserSys.data.history.length > 20) UserSys.data.history.pop();
                UserSys.save();
            },
            openProfile: () => {
                document.getElementById('p-name').innerText = UserSys.data.name;
                document.getElementById('p-class').innerText = UserSys.data.class;
                document.getElementById('p-score').innerText = UserSys.data.score;
                const list = document.getElementById('p-history'); list.innerHTML = '';
                UserSys.data.history.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'history-item ' + (h.change < 0 ? 'bad' : '');
                    div.innerHTML = `<span>${h.event}</span><span>${h.change}</span>`;
                    list.appendChild(div);
                });
                document.getElementById('profile-modal').style.display = 'flex'; AudioSys.sfx('pop');
            },
            reset: () => { if(confirm("ç¡®å®šè¦é”€æ¯æ¡£æ¡ˆå—ï¼Ÿ(æ•°æ®å°†æ¸…ç©º)")) { localStorage.removeItem(UserSys.key); location.reload(); } }
        };

        // --- äº‘ç«¯ç³»ç»Ÿ (LeanCloud å¢å¼ºç‰ˆ) ---
        const CloudSys = {
            enabled: false,
            init: () => {
                const APP_ID = "ClQ56mtSJOXyNtufV0Vcg7Uj-MdYXbMMI";     
                const APP_KEY = "kvFqvwOT85rZXDqQ5384E8Xf";
                const SERVER_URL = "https://clq56mts.api.lncldglobal.com";

                if (typeof AV !== 'undefined' && APP_ID && APP_KEY) {
                    try {
                        AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
                        CloudSys.enabled = true;
                        console.log("äº‘ç«¯è¿æ¥æˆåŠŸ");
                    } catch(e) { console.error("äº‘ç«¯åˆå§‹åŒ–å¤±è´¥", e); }
                }
            },
            
            // ä¸Šä¼ åˆ†æ•°
            upload: (mode, score) => {
                if(!CloudSys.enabled) return;
                const ScoreObj = AV.Object.extend('GameScores');
                const record = new ScoreObj();
                record.set('studentName', UserSys.data.name);
                record.set('studentClass', UserSys.data.class);
                record.set('score', Number(score));
                record.set('mode', mode);
                record.save().catch(e => console.error(e));
            },

            // æ‰“å¼€æ’è¡Œæ¦œé¢æ¿ (å¤ç”¨å…¬å‘Šå¼¹çª—)
            openRankPanel: () => {
                if(!CloudSys.enabled) { alert("è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½® LeanCloud AppID å’Œ Key æ‰èƒ½ä½¿ç”¨è”ç½‘æ’è¡Œï¼"); return; }
                
                // å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·é€‰æ¨¡å¼
                const mode = prompt("è¯·è¾“å…¥è¦æŸ¥è¯¢çš„æ¸¸æˆä»£ç ï¼š\nA=åˆæˆ\nB=è´¸æ˜“\nC=é˜²è…\nD=PK\nE=å·¡è§†\nF=è¯†äºº", "A");
                if(!mode) return;
                
                const gameMode = mode.toUpperCase();
                if(!['A','B','C','D','E','F'].includes(gameMode)) { alert("æ— æ•ˆçš„æ¸¸æˆä»£ç "); return; }

                // æ˜¾ç¤ºâ€œåŠ è½½ä¸­...â€
                const noticeBox = document.querySelector('#notice-modal .notice-content');
                document.querySelector('#notice-modal h3').innerText = `ğŸ† æ¸¸æˆ [${gameMode}] æ’è¡Œæ¦œ`;
                noticeBox.innerHTML = '<div style="text-align:center; padding:20px;">æ­£åœ¨ä»æ•™åŠ¡å¤„æ‹‰å–æ•°æ®...</div>';
                document.getElementById('notice-modal').style.display = 'flex';

                // æŸ¥è¯¢äº‘ç«¯
                const query = new AV.Query('GameScores');
                query.equalTo('mode', gameMode);
                // æ¸¸æˆ F æ˜¯æ—¶é—´è¶ŠçŸ­è¶Šå¥½ï¼Œå…¶ä»–æ˜¯åˆ†è¶Šé«˜è¶Šå¥½
                if(gameMode === 'F') query.ascending('score'); 
                else query.descending('score');
                
                query.limit(10); // å–å‰10å

                query.find().then(results => {
                    let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
                    html += '<tr style="background:#eee; text-align:left;"><th style="padding:5px;">æ’å</th><th>ç­çº§</th><th>å§“å</th><th>åˆ†æ•°</th></tr>';
                    
                    if(results.length === 0) {
                        html += '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">æš‚æ— æ•°æ®ï¼Œå¿«å»æŠ¢æ²™å‘ï¼</td></tr>';
                    } else {
                        results.forEach((r, i) => {
                            const medal = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1)));
                            const color = i<3 ? 'color:#e67e22; font-weight:bold;' : '';
                            html += `<tr style="border-bottom:1px dashed #ddd;">
                                <td style="padding:8px; ${color}">${medal}</td>
                                <td>${r.get('studentClass')}</td>
                                <td>${r.get('studentName')}</td>
                                <td style="font-weight:bold;">${r.get('score')}</td>
                            </tr>`;
                        });
                    }
                    html += '</table>';
                    html += '<p style="font-size:0.8rem; color:#999; margin-top:10px; text-align:center;">* ä»…æ˜¾ç¤ºå…¨æ ¡å‰10åå·ç‹</p>';
                    noticeBox.innerHTML = html;
                }).catch(error => {
                    noticeBox.innerHTML = `<div style="color:red; text-align:center;">è·å–å¤±è´¥: ${error.message}</div>`;
                });
            }
        };
          
        

        // --- éŸ³é¢‘ç³»ç»Ÿ ---
        const AudioSys = {
            ctx: null,
            init: () => {
                if(!AudioSys.ctx) AudioSys.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if(AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
            },
            sfx: (type) => {
                if(isMuted || !AudioSys.ctx) return;
                const t = AudioSys.ctx.currentTime;
                const osc = AudioSys.ctx.createOscillator();
                const gain = AudioSys.ctx.createGain();
                osc.connect(gain); gain.connect(AudioSys.ctx.destination);
                if(type === 'pop') { 
                    osc.frequency.setValueAtTime(400, t); osc.frequency.exponentialRampToValueAtTime(800, t+0.1);
                    gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.1); osc.start(t); osc.stop(t+0.1);
                } else if(type === 'win') {
                    osc.type='triangle'; osc.frequency.setValueAtTime(500, t); osc.frequency.setValueAtTime(800, t+0.1);
                    gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3);
                } else if(type === 'bad') {
                    osc.type='sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t+0.3);
                    gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3);
                } else if(type === 'flip') {
                    osc.frequency.setValueAtTime(600, t); gain.gain.setValueAtTime(0.05, t); gain.gain.linearRampToValueAtTime(0, t+0.1); osc.start(t); osc.stop(t+0.1);
                }
            }
        };

        function toggleMute() { AudioSys.init(); isMuted = !isMuted; document.getElementById('mute-btn').innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; }

        // --- èµ„æºåŠ è½½ ---
        let loadedCount = 0;
        const getLocalPath = (index) => `./${1000102660 + index}.png`;
        function initLoader() { TEACHERS.forEach((t, i) => { loadWithFallback(i, t.src, getLocalPath(i)); }); }
        function loadWithFallback(index, remoteUrl, localUrl) {
            const img = new Image(); img.crossOrigin = "anonymous"; 
            img.onload = () => { ASSETS[index] = img; checkLoad(); };
            img.onerror = () => {
                const localImg = new Image(); localImg.src = localUrl;
                localImg.onload = () => { ASSETS[index] = localImg; checkLoad(); };
                localImg.onerror = () => { ASSETS[index] = createPlaceholder(TEACHERS[index].radius, index); checkLoad(); };
            };
            img.src = remoteUrl; 
        }
        function createPlaceholder(radius, index) {
            const cvs = document.createElement('canvas'); cvs.width = radius * 2; cvs.height = radius * 2;
            const ctx = cvs.getContext('2d');
            const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#1abc9c', '#3498db', '#9b59b6', '#34495e', '#7f8c8d', '#2c3e50'];
            ctx.beginPath(); ctx.arc(radius, radius, radius, 0, Math.PI * 2);
            ctx.fillStyle = colors[index % colors.length]; ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 20px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(index, radius, radius);
            const newImg = new Image(); newImg.src = cvs.toDataURL(); return newImg;
        }
        function checkLoad() {
            loadedCount++; const bar = document.getElementById('loading-bar'); if(bar) bar.innerText = Math.floor(loadedCount / TEACHERS.length * 100) + '%';
            if(loadedCount >= TEACHERS.length) {
                document.getElementById('loading-screen').style.display = 'none';
                if(!localStorage.getItem(UserSys.key)) document.getElementById('login-modal').style.display = 'flex';
                else { UserSys.init(); document.getElementById('menu-screen').style.display = 'flex'; }
            }
        }
        initLoader();

        // --- é€šç”¨åŠŸèƒ½ ---
        function openUpdateLink() {
            const i = document.createElement('input'); i.value = ''; document.body.appendChild(i);
            i.select(); document.execCommand('copy'); document.body.removeChild(i);
            window.open('https://www.123912.com/s/iHgZVv-LDO0H', '_blank');
        }
        function openNotice() { document.getElementById('notice-modal').style.display = 'flex'; AudioSys.sfx('pop'); }
        function closeNotice() { document.getElementById('notice-modal').style.display = 'none'; }

        // --- æ¸¸æˆç®¡ç† ---
        let activeGame = null;
        let gameData = {};

        function startGame(mode) {
            AudioSys.init();
            document.getElementById('menu-screen').style.display = 'none';
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            ['a','b','c','d','e','f'].forEach(id => document.getElementById(`game-${id}-container`).style.display = 'none');
            document.getElementById(`game-${mode.toLowerCase()}-container`).style.display = 'flex';
            cleanupAll();
            activeGame = mode;
            if(mode==='A') initGameA(); if(mode==='B') initGameB(); if(mode==='C') initGameC();
            if(mode==='D') initGameD(); if(mode==='E') initGameE(); if(mode==='F') initGameF();
        }

        function backToMenu() {
            cleanupAll(); activeGame = null;
            document.querySelectorAll('.full-screen').forEach(el => el.style.display = 'none');
            document.getElementById('menu-screen').style.display = 'flex';
        }

        function cleanupAll() {
            if(gameData.A) { 
                Matter.Runner.stop(gameData.A.runner); Matter.Engine.clear(gameData.A.engine); 
                gameData.A.canvas.remove(); 
                if(gameData.A.btn) gameData.A.btn.remove(); // æ¸…ç†æ´—ç‰ŒæŒ‰é’®
                gameData.A = null; 
            }
            if(gameData.B) { cancelAnimationFrame(gameData.B); gameData.B = null; }
            if(gameData.C) { cancelAnimationFrame(gameData.C); gameData.C = null; }
            if(gameData.D) { cancelAnimationFrame(gameData.D); gameData.D = null; window.removeEventListener('resize', checkOrientation); }
            if(gameData.E) { clearInterval(gameData.E.timer); clearTimeout(gameData.E.spawnTimer); gameData.E = null; }
            if(gameData.F) { clearInterval(gameData.F.timer); gameData.F = null; }
        }

        // ================= GAME A: åˆæˆ (å¸¦æ´—ç‰Œ) =================
        function initGameA() {
            const Engine = Matter.Engine, Runner = Matter.Runner, Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, Body = Matter.Body;
            const container = document.getElementById('game-a-container');
            const canvas = document.createElement('canvas');
            canvas.width = container.clientWidth; canvas.height = container.clientHeight;
            container.insertBefore(canvas, container.firstChild);
            
            // --- æ´—ç‰ŒæŒ‰é’® ---
            let shuffleBtn = document.createElement('button');
            shuffleBtn.innerText = "ğŸ”„ æ´—ç‰Œ (3)";
            shuffleBtn.style.cssText = "position:absolute; top:70px; right:10px; background:#f39c12; color:white; border:none; padding:8px 12px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2); cursor:pointer; z-index:100;";
            container.appendChild(shuffleBtn);
            let shuffleCount = 3;

            const engine = Engine.create({ gravity: { y: 1.5 } });
            const runner = Runner.create();
            const ctx = canvas.getContext('2d');
            const width = canvas.width, height = canvas.height;

            Composite.add(engine.world, [
                Bodies.rectangle(width/2, height+50, width, 100, { isStatic: true }),
                Bodies.rectangle(-10, height/2, 20, height*2, { isStatic: true }),
                Bodies.rectangle(width+10, height/2, 20, height*2, { isStatic: true })
            ]);

            let score = 0, curBody = null, canDrop = true, nextLvl = 0;
            document.getElementById('score-a').innerText = '0';

            function updatePreview() { nextLvl = Math.floor(Math.random()*4); document.getElementById('next-preview-img').src = ASSETS[nextLvl].src; }
            updatePreview();

            // æ´—ç‰Œé€»è¾‘
            shuffleBtn.onclick = (e) => {
                e.stopPropagation();
                if(shuffleCount > 0) {
                    shuffleCount--; shuffleBtn.innerText = `ğŸ”„ æ´—ç‰Œ (${shuffleCount})`; shuffleBtn.style.opacity = shuffleCount > 0 ? 1 : 0.5;
                    AudioSys.sfx('pop');
                    UserSys.deduct("ä½¿ç”¨é“å…·", 2, "è¡Œæ”¿å¹²é¢„(æ´—ç‰Œ)");
                    Composite.allBodies(engine.world).forEach(b => {
                        if(!b.isStatic && b.label === 'fruit') {
                            const force = { x: (Math.random() - 0.5) * 0.1 * b.mass, y: -0.08 * b.mass };
                            Body.applyForce(b, b.position, force);
                        }
                    });
                }
            };

            function spawn() {
                curBody = Bodies.circle(width/2, 80, TEACHERS[nextLvl].radius, { isStatic: true, label: 'fruit', isSensor: true, customLvl: nextLvl });
                Composite.add(engine.world, curBody); canDrop = true; updatePreview();
            }

            const move = (x) => { if(curBody && canDrop) Body.setPosition(curBody, { x: Math.max(curBody.circleRadius, Math.min(width-curBody.circleRadius, x)), y: 80 }); };
            container.onpointermove = e => { e.preventDefault(); move(e.clientX); };
            container.onpointerdown = e => { if(e.target !== shuffleBtn) move(e.clientX); };
            container.onpointerup = (e) => { 
                if(e.target === shuffleBtn) return;
                if(curBody && canDrop) { canDrop=false; Body.setStatic(curBody, false); curBody.isSensor=false; AudioSys.sfx('pop'); curBody=null; setTimeout(spawn, 800); }
            };

            Events.on(engine, 'collisionStart', e => {
                e.pairs.forEach(p => {
                    const a = p.bodyA, b = p.bodyB;
                    if(a.label==='fruit' && b.label==='fruit' && a.customLvl===b.customLvl && !a.toRemove) {
                        if(a.customLvl < TEACHERS.length-1) {
                            a.toRemove = b.toRemove = true;
                            Composite.remove(engine.world, [a,b]);
                            Composite.add(engine.world, Bodies.circle((a.position.x+b.position.x)/2, (a.position.y+b.position.y)/2, TEACHERS[a.customLvl+1].radius, { label: 'fruit', customLvl: a.customLvl+1, restitution: 0.2 }));
                            score += TEACHERS[a.customLvl].score; document.getElementById('score-a').innerText = score; AudioSys.sfx('pop');
                        }
                    }
                });
            });

            Events.on(runner, 'afterUpdate', () => {
                ctx.clearRect(0,0,width,height);
                ctx.beginPath(); ctx.moveTo(0,150); ctx.lineTo(width,150); ctx.strokeStyle='rgba(231,76,60,0.5)'; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
                Composite.allBodies(engine.world).forEach(b => {
                    if(b.label === 'fruit') {
                        const img = ASSETS[b.customLvl];
                        ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
                        ctx.beginPath(); ctx.arc(0,0,b.circleRadius,0,6.28); ctx.clip();
                        if(img) ctx.drawImage(img, -b.circleRadius, -b.circleRadius, b.circleRadius*2, b.circleRadius*2);
                        ctx.restore();
                        // ç»“æŸåˆ¤å®š
                        if(!b.isSensor && b.position.y < 150 && b.speed < 0.2 && !curBody && !canDrop) {
                             Runner.stop(runner); 
                             document.getElementById('final-score-a').innerText=score; 
                             UserSys.deduct("åˆæˆç‰¢æ ¡é•¿", 5, "å®¹å™¨æº¢å‡º");
                             CloudSys.upload('A', score);
                             if(shuffleBtn) shuffleBtn.remove();
                             document.getElementById('modal-a').style.display='flex';
                        }
                    }
                });
            });
            spawn(); Runner.run(runner, engine); gameData.A = { engine, runner, canvas, btn: shuffleBtn };
        }

        // ================= GAME B: çŸ¿å·¥ =================
        function initGameB() {
            const cvs = document.getElementById('canvas-b'), ctx = cvs.getContext('2d');
            const W = cvs.width = cvs.parentElement.clientWidth, H = cvs.height = cvs.parentElement.clientHeight;
            let score=0, time=60, lastT=Date.now(), hook={x:W/2,y:50,ang:1.57,len:30,st:0,sp:0,dir:1,t:null}, items=[];
            for(let i=0;i<10;i++) { const l=Math.floor(Math.random()*10); items.push({x:40+Math.random()*(W-80),y:150+Math.random()*(H-200),l:l,r:TEACHERS[l].radius*0.6,s:TEACHERS[l].score,w:(l+1)*0.5}); }
            cvs.onpointerdown = () => { if(hook.st===0) { hook.st=1; AudioSys.sfx('pop'); } };
            function loop() {
                if(activeGame!=='B') return;
                if(Date.now()-lastT>1000) { 
                    time--; document.getElementById('timer-b').innerText=time; lastT=Date.now(); 
                    if(time<=0) { 
                        document.getElementById('final-score-b').innerText=score; 
                        UserSys.deduct("ä¸‰è§’è´¸æ˜“", 3, "éæ³•è´¸æ˜“ï¼Œæ•°é¢ä¸è¶³");
                        CloudSys.upload('B', score);
                        document.getElementById('modal-b').style.display='flex'; return; 
                    }
                }
                if(hook.st===0) { hook.ang+=0.03*hook.dir; if(hook.ang>2.5||hook.ang<0.6) hook.dir*=-1; }
                else if(hook.st===1) {
                    hook.len+=15; const hx=hook.x+Math.cos(hook.ang)*hook.len, hy=hook.y+Math.sin(hook.ang)*hook.len;
                    if(hx<0||hx>W||hy>H) { hook.st=2; hook.sp=20; }
                    for(let i of items) if(!i.c && Math.hypot(hx-i.x,hy-i.y)<i.r) { hook.st=2; hook.t=i; i.c=true; hook.sp=Math.max(5,20/i.w); AudioSys.sfx('pop'); break; }
                } else {
                    hook.len-=hook.sp;
                    if(hook.len<=30) { hook.len=30; hook.st=0; if(hook.t) { score+=hook.t.s; document.getElementById('score-b').innerText=score; items=items.filter(x=>x!==hook.t); hook.t=null; AudioSys.sfx('win'); if(items.length<2) items.push({x:Math.random()*W,y:200+Math.random()*200,l:5,r:40,s:100,w:2}); } }
                }
                ctx.clearRect(0,0,W,H);
                const tx=hook.x+Math.cos(hook.ang)*hook.len, ty=hook.y+Math.sin(hook.ang)*hook.len;
                ctx.beginPath(); ctx.moveTo(hook.x,hook.y); ctx.lineTo(tx,ty); ctx.lineWidth=3; ctx.strokeStyle='#333'; ctx.stroke();
                items.forEach(i => {
                    let ix=i.c?tx:i.x, iy=i.c?ty+i.r/2:i.y;
                    ctx.save(); ctx.translate(ix,iy);
                    if(ASSETS[i.l]) ctx.drawImage(ASSETS[i.l],-i.r,-i.r,i.r*2,i.r*2); else { ctx.beginPath(); ctx.arc(0,0,i.r,0,6.28); ctx.fillStyle='gold'; ctx.fill(); }
                    ctx.restore();
                });
                ctx.beginPath(); ctx.arc(tx,ty,5,0,6.28); ctx.fillStyle='red'; ctx.fill();
                gameData.B = requestAnimationFrame(loop);
            }
            gameData.B = requestAnimationFrame(loop);
        }

        // ================= GAME C: æ‹’è…é˜²å˜ =================
        function initGameC() {
            const cvs = document.getElementById('canvas-c'), ctx = cvs.getContext('2d');
            const W = cvs.width = cvs.parentElement.clientWidth, H = cvs.height = cvs.parentElement.clientHeight;
            let bird = { x: 60, y: H/2, vy: 0, r: 25 }, obstacles = [], score = 0, state = 0, startTime = 0;
            document.getElementById('score-c').innerText = '0'; document.getElementById('overlay-c').style.display = 'flex';
            cvs.parentElement.onpointerdown = (e) => {
                e.preventDefault();
                if(state===0) { state=1; document.getElementById('overlay-c').style.display='none'; bird.vy=-6; startTime=Date.now(); }
                else if(state===1) { bird.vy = -7; AudioSys.sfx('pop'); }
            };
            function loop() {
                if(activeGame!=='C' || state===2) return;
                ctx.clearRect(0,0,W,H);
                if(state===1) {
                    bird.vy += 0.35; bird.y += bird.vy;
                    score = ((Date.now() - startTime)/1000).toFixed(1); document.getElementById('score-c').innerText = score;
                    if(Math.random() < 0.03) obstacles.push({ x: W, y: Math.random()*(H-60), r: 25, type: Math.random()>0.5 ? 'bag':'red' });
                    obstacles.forEach(o => o.x -= 4); obstacles = obstacles.filter(o => o.x > -50);
                    if(bird.y<0 || bird.y>H) die();
                    for(let o of obstacles) { if(Math.hypot(bird.x-o.x, bird.y-o.y) < (bird.r + o.r - 10)) die(); }
                }
                const img = ASSETS[9]; 
                ctx.save(); ctx.translate(bird.x, bird.y); ctx.rotate(bird.vy*0.05);
                if(img) { ctx.beginPath(); ctx.arc(0,0,bird.r,0,6.28); ctx.clip(); ctx.drawImage(img, -bird.r, -bird.r, bird.r*2, bird.r*2); ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke(); }
                ctx.restore();
                obstacles.forEach(o => { ctx.font = '40px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(o.type==='bag' ? 'ğŸ’°' : 'ğŸ§§', o.x, o.y); });
                gameData.C = requestAnimationFrame(loop);
            }
            function die() {
                state=2; AudioSys.sfx('bad');
                document.getElementById('final-score-c').innerText = score;
                UserSys.deduct("è‡ªåŠ¨æ‹¾å–", 10, "æ”¶å—çº¢åŒ…ï¼Œè¢«è…èš€");
                CloudSys.upload('C', score);
                document.getElementById('modal-c').style.display = 'flex';
            }
            gameData.C = requestAnimationFrame(loop);
        }

        // ================= GAME D: PVP =================
        function checkOrientation() { document.getElementById('rotate-tip').style.display = window.innerHeight > window.innerWidth ? 'flex' : 'none'; }
        function initGameD() {
            window.addEventListener('resize', checkOrientation); checkOrientation();
            const cvs = document.getElementById('canvas-d'), ctx = cvs.getContext('2d');
            const W = cvs.width = cvs.parentElement.clientWidth, H = cvs.height = cvs.parentElement.clientHeight;
            let p1={x:W*0.2,v:0}, p2={x:W*0.8,v:0}, active=true;
            document.getElementById('p1-btn').onpointerdown=(e)=>{e.preventDefault(); if(active){p1.v+=6; AudioSys.sfx('pop');}};
            document.getElementById('p2-btn').onpointerdown=(e)=>{e.preventDefault(); if(active){p2.v-=6; AudioSys.sfx('pop');}};
            function loop() {
                if(activeGame!=='D' || !active) return;
                p1.x+=p1.v; p2.x+=p2.v; p1.v*=0.9; p2.v*=0.9;
                if(p2.x-p1.x < 80) { let push=(80-(p2.x-p1.x))/2; p1.x-=push; p2.x+=push; p1.v=-5; p2.v=5; }
                if(p1.x<0) win('è“æ–¹'); if(p2.x>W) win('çº¢æ–¹');
                ctx.clearRect(0,0,W,H);
                ctx.beginPath(); ctx.moveTo(W/2,0); ctx.lineTo(W/2,H); ctx.strokeStyle='#fff'; ctx.setLineDash([10,10]); ctx.stroke();
                ctx.save(); ctx.translate(p1.x, H/2); ctx.beginPath(); ctx.arc(0,0,40,0,6.28); ctx.fillStyle='#e74c3c'; ctx.fill(); if(ASSETS[9]) ctx.drawImage(ASSETS[9],-35,-35,70,70); ctx.restore();
                ctx.save(); ctx.translate(p2.x, H/2); ctx.scale(-1,1); ctx.beginPath(); ctx.arc(0,0,40,0,6.28); ctx.fillStyle='#3498db'; ctx.fill(); if(ASSETS[10]) ctx.drawImage(ASSETS[10],-35,-35,70,70); ctx.restore();
                gameData.D = requestAnimationFrame(loop);
            }
            function win(w) { 
                active=false; AudioSys.sfx('win'); document.getElementById('winner-d').innerText=w+'è·èƒœ'; 
                UserSys.deduct("é«˜ç‹PK", 2, "å‚ä¸æ–—æ®´ï¼Œé€ æˆæ¶åŠ£å½±å“");
                document.getElementById('modal-d').style.display='flex'; 
            }
            gameData.D = requestAnimationFrame(loop);
        }

        // ================= GAME E: å·¡è§† =================
        function initGameE() {
            const grid = document.getElementById('grid-e'); grid.innerHTML = '';
            let score=0, time=30; document.getElementById('score-e').innerText=0; document.getElementById('timer-e').innerText=30;
            let cells=[];
            for(let i=0;i<9;i++){
                let c=document.createElement('div'), img=document.createElement('img');
                c.className='window-cell'; img.className='window-img'; c.appendChild(img);
                c.onpointerdown = ()=>{ 
                    if(c.classList.contains('active')) {
                        if(c.isBad) { score+=10; AudioSys.sfx('pop'); c.style.backgroundColor='#2ecc71'; }
                        else { score-=20; AudioSys.sfx('bad'); c.style.backgroundColor='#e74c3c'; }
                        document.getElementById('score-e').innerText=score;
                        c.classList.remove('active'); img.classList.remove('show');
                    }
                };
                grid.appendChild(c); cells.push({el:c, img:img});
            }
            const tInt = setInterval(()=>{ 
                time--; document.getElementById('timer-e').innerText=time; 
                if(time<=0){ 
                    clearInterval(tInt); clearTimeout(sT); 
                    document.getElementById('final-score-e').innerText=score; 
                    UserSys.deduct("æ¨¡æ‹Ÿæ ¡é•¿", 5, "ç›‘ç®¡ä¸åŠ›ï¼Œè€å¸ˆæ‘¸é±¼");
                    CloudSys.upload('E', score);
                    document.getElementById('modal-e').style.display='flex'; 
                }
            },1000);
            let sT;
            function spawn() {
                let empty = cells.filter(c=>!c.el.classList.contains('active'));
                if(empty.length) {
                    let cell = empty[Math.floor(Math.random()*empty.length)];
                    cell.el.isBad = Math.random()>0.3; 
                    let id = cell.el.isBad ? Math.floor(Math.random()*5) : 9; 
                    cell.img.src = ASSETS[id].src;
                    cell.el.classList.add('active'); cell.el.classList.add('lit'); cell.img.classList.add('show'); cell.el.style.backgroundColor='#555';
                    setTimeout(()=>{ cell.el.classList.remove('active'); cell.el.classList.remove('lit'); cell.img.classList.remove('show'); }, 1200);
                }
                sT = setTimeout(spawn, 600);
            }
            spawn(); gameData.E = { timer:tInt, spawnTimer:sT };
        }

        // ================= GAME F: æ…§çœ¼è¯†äºº =================
        function initGameF() {
            const grid = document.getElementById('grid-f'); grid.innerHTML = '';
            let indices = [0,1,2,3,4,5,6,9]; let pairs = [...indices, ...indices];
            for(let i=pairs.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [pairs[i],pairs[j]]=[pairs[j],pairs[i]]; }
            let opened = [], matched = 0, time = 45;
            document.getElementById('timer-f').innerText = time; document.getElementById('deduct-f').style.display = 'none';
            pairs.forEach((pid, i) => {
                const card = document.createElement('div'); card.className = 'card';
                card.innerHTML = `<div class="card-face card-front">?</div><div class="card-face card-back"><img src="${ASSETS[pid].src}"></div>`;
                card.onclick = () => {
                    if(opened.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
                        card.classList.add('flipped'); AudioSys.sfx('flip'); opened.push({ el: card, id: pid });
                        if(opened.length === 2) checkMatch();
                    }
                };
                grid.appendChild(card);
            });
            function checkMatch() {
                const [c1, c2] = opened;
                if(c1.id === c2.id) { AudioSys.sfx('pop'); setTimeout(() => { c1.el.classList.add('matched'); c2.el.classList.add('matched'); opened = []; matched++; if(matched === 8) win(); }, 500); } 
                else { AudioSys.sfx('bad'); setTimeout(() => { c1.el.classList.remove('flipped'); c2.el.classList.remove('flipped'); opened = []; }, 800); }
            }
            const tInt = setInterval(() => {
                time--; document.getElementById('timer-f').innerText = time;
                if(time <= 0) {
                    clearInterval(tInt);
                    document.getElementById('title-f').innerText = "ä»»å‘½å¤±è´¥"; document.getElementById('title-f').style.color = "#e74c3c";
                    document.getElementById('final-score-f').innerText = "è¶…æ—¶";
                    document.getElementById('deduct-f').style.display = 'block';
                    UserSys.deduct("æ…§çœ¼è¯†äºº", 3, "æ•ˆç‡ä½ä¸‹");
                    document.getElementById('modal-f').style.display = 'flex';
                }
            }, 1000);
            function win() {
                clearInterval(tInt); AudioSys.sfx('win');
                document.getElementById('title-f').innerText = "ä»»å‘½å®Œæˆ!"; document.getElementById('title-f').style.color = "#2ecc71";
                let finalScore = 45 - time;
                document.getElementById('final-score-f').innerText = "è€—æ—¶: " + finalScore + "s";
                document.getElementById('deduct-f').style.display = 'none';
                CloudSys.upload('F', finalScore); 
                document.getElementById('modal-f').style.display = 'flex';
            }
            gameData.F = { timer: tInt };
        }
    </script>


</body>
</html>
